<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>ApoTakeCare - Places</title>
	<link rel="stylesheet" href="/general.css">
	<link rel="stylesheet" href="/pico.jade.min.css">
</head>
<body>
<main class="container">
	<!-- Header : -->	
	<div th:replace="~{frag :: header}"></div>

	<h1>All the places :</h1>	
	
	<div class="table-wrapper"><table>		
		<thead>
	       	 <tr>
	            <th>ID</th>
	            <th>Place Name</th>
	            <th>Longitude</th>
	            <th>Latitude</th>
	            <th>Products</th>
	        </tr>
    	</thead>
    	<tbody>
	    	<tr th:each="place : ${places}">
			<td th:text="${place.id}">XXX</td>
			<td th:text="${place.name}">(NAME)</td>
			<td th:text="${place.longitude}">(DESCRIPT)</td>
			<td th:text="${place.latitude}">(DESCRIPT)</td>
			<td>
				<ul>
					<li th:each="product : ${place.dispoProduct}" th:text="${product.name}">Product Name</li>
				</ul>
			</td>
			<td>
			<form class="product-form" th:attr="data-place-id=${place.id}">
                		<select id="productSelect" name="productId" required>
                    		<option value="" disabled selected>Select a product</option>
                    		<option th:each="product : ${products}" th:value="${product.id}" th:text="${product.name}">
                        		Product Name
                    		</option>
                		</select>
                		<button type="button" class="btn btn-primary add-product-button">Add Product</button>
                		<button type="button" class="btn btn-warning remove-product-button">Remove Product</button>
            		</form>
    			</td>

			</tr>
    	</tbody>		
	</table></div>
	
	<!-- FOOTER -->
	<div th:replace="~{frag :: footer}"></div>
</main>
</body>
	<script>

//todo heu ajax casse un peu les couilles, ça marche mais ça met pas à jour directement, faut refresh
document.addEventListener("DOMContentLoaded", function () {
    
    document.querySelectorAll(".add-product-button").forEach(button => {
        button.addEventListener("click", function () {
            const form = this.closest(".product-form");
            const placeId = form.getAttribute("data-place-id");
            const productId = form.querySelector("#productSelect").value;

            if (!productId) {
                alert("Please select a product.");
                return;
            }

            console.log(`Adding product with ID: ${productId} to place with ID: ${placeId}`);

            
            fetch(`/${placeId}/add-product`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({ productId }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to add product. Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log("Response data:", data);

                    
                    const productList = document.querySelector(`#productList-${placeId}`);
                    if (productList) {
                        
                        const selectedOption = form.querySelector(`#productSelect option[value="${productId}"]`);
                        const productName = selectedOption.textContent;

                        
                        const newProduct = document.createElement("li");
                        newProduct.textContent = productName;
                        productList.appendChild(newProduct);

                        console.log("Product added to the list.");
                        alert("Product added successfully!");
                    } else {
                        console.error(`Product list not found for place ID: ${placeId}`);
                    }
                })
                .catch(error => {
                    console.error("Error details:", error);
                    alert("An error occurred while adding the product.");
                });
        });
    });

    
    document.querySelectorAll(".remove-product-button").forEach(button => {
        button.addEventListener("click", function () {
            const form = this.closest(".product-form");
            const placeId = form.getAttribute("data-place-id");
            const productId = form.querySelector("#productSelect").value;

            if (!productId) {
                alert("Please select a product.");
                return;
            }

            console.log(`Removing product with ID: ${productId} from place with ID: ${placeId}`);

          
            fetch(`/${placeId}/remove-product/${productId}`, {
                method: "DELETE",
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to remove product. Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log("Response data:", data);

                    
                    const productList = document.querySelector(`#productList-${placeId}`);
                    if (productList) {
                        const items = productList.querySelectorAll("li");
                        items.forEach(item => {
                            if (item.textContent.trim() === form.querySelector(`#productSelect option[value="${productId}"]`).textContent.trim()) {
                                item.remove();
                            }
                        });

                        console.log("Product removed from the list.");
                        alert("Product removed successfully!");
                    } else {
                        console.error(`Product list not found for place ID: ${placeId}`);
                    }
                })
                .catch(error => {
                    console.error("Error details:", error);
                    alert("An error occurred while removing the product.");
                });
        });
    });
});



</script>
</html>
